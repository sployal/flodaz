<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntaSend Payment App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            max-width: 500px;
            width: 100%;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .form-container {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4facfe;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .currency-group {
            display: flex;
            gap: 10px;
        }

        .currency-group select {
            flex: 1;
        }

        .currency-group input {
            flex: 2;
        }

        .pay-button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 18px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pay-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .pay-button:active {
            transform: translateY(0);
        }

        .pay-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .config-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .config-section h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1rem;
        }

        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .payment-method {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-method:hover {
            border-color: #4facfe;
            transform: translateY(-2px);
        }

        .payment-method.selected {
            border-color: #4facfe;
            background: #f0f9ff;
        }

        .footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            color: #666;
            font-size: 0.9rem;
        }

        .api-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .api-info h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .code-snippet {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí≥ IntaSend Payment</h1>
            <p>Direct API Integration</p>
        </div>

        <div class="form-container">
            <!-- API Configuration Section -->
            <div class="config-section">
                <h3>üîë API Configuration</h3>
                <div class="form-group">
                    <label for="publishableKey">Publishable Key</label>
                    <input type="text" id="publishableKey" placeholder="ISPubKey_test_..." value="ISPubKey_test_0c2a0c0d-b406-43e6-9a53-50967c70d608">
                </div>
                <div class="form-group">
                    <label for="secretKey">Secret Key (Required for API calls)</label>
                    <input type="password" id="secretKey" placeholder="ISSecretKey_test_...">
                </div>
                <div class="form-group">
                    <label for="apiEnvironment">Environment</label>
                    <select id="apiEnvironment">
                        <option value="test" selected>Test (Sandbox)</option>
                        <option value="live">Live (Production - Requires Account Verification)</option>
                    </select>
                </div>
            </div>

            <!-- Important Info -->
            <div class="api-info">
                <h4>üìã Important Requirements:</h4>
                <p><strong>1.</strong> You need both Publishable Key AND Secret Key for M-PESA STK Push</p>
                <p><strong>2.</strong> For live payments, your IntaSend account must be verified</p>
                <p><strong>3.</strong> Phone number must be registered with M-PESA</p>
                <p><strong>4.</strong> Test environment works without account verification</p>
            </div>

            <!-- Status Messages -->
            <div id="statusMessage" class="status-message"></div>

            <!-- Payment Form -->
            <form id="paymentForm">
                <div class="form-group">
                    <label for="customerEmail">Email Address</label>
                    <input type="email" id="customerEmail" required placeholder="customer@example.com">
                </div>

                <div class="form-group">
                    <label for="customerPhone">Phone Number (M-PESA Registered)</label>
                    <input type="tel" id="customerPhone" required placeholder="+254700000000">
                </div>

                <div class="form-group">
                    <label for="customerName">Full Name</label>
                    <input type="text" id="customerName" required placeholder="John Doe">
                </div>

                <div class="form-group">
                    <label>Amount</label>
                    <div class="currency-group">
                        <select id="currency">
                            <option value="KES">KES</option>
                            <option value="USD">USD</option>
                        </select>
                        <input type="number" id="amount" required min="1" step="0.01" placeholder="10.00" value="10">
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">Payment Description</label>
                    <textarea id="description" rows="3" placeholder="Test payment">Test payment</textarea>
                </div>

                <div class="form-group">
                    <label>Payment Method</label>
                    <div class="payment-methods">
                        <div class="payment-method selected" data-method="MPESA">
                            <div>üì±</div>
                            <div>M-PESA STK</div>
                        </div>
                        <div class="payment-method" data-method="CHECKOUT">
                            <div>üåê</div>
                            <div>Web Checkout</div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="pay-button" id="payButton">
                    Initiate Payment
                </button>
            </form>

            <!-- Backend Code Section -->
            <div class="config-section" style="margin-top: 30px;">
                <h3>üîß Backend Code (Copy this to your server)</h3>
                <p style="margin-bottom: 10px; color: #666;">Since direct API calls from browser have CORS issues, here's the backend code you need:</p>
                <div class="code-snippet">
                    <strong>Node.js/Express Backend:</strong><br>
                    app.post('/api/mpesa-payment', async (req, res) => {<br>
                    &nbsp;&nbsp;const response = await fetch('https://sandbox.intasend.com/api/v1/payment/mpesa-stk-push/', {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;method: 'POST',<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;headers: {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Content-Type': 'application/json',<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'X-IntaSend-Public-Key-Id': 'YOUR_PUBLISHABLE_KEY',<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'X-IntaSend-Secret-Key-Id': 'YOUR_SECRET_KEY'<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;},<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;body: JSON.stringify(req.body)<br>
                    &nbsp;&nbsp;});<br>
                    &nbsp;&nbsp;const result = await response.json();<br>
                    &nbsp;&nbsp;res.json(result);<br>
                    });
                </div>
            </div>
        </div>

        <div class="footer">
            <p>üîí Secure payments ‚Ä¢ SSL Encrypted ‚Ä¢ PCI Compliant</p>
        </div>
    </div>

    <script>
        class IntaSendPayment {
            constructor() {
                this.selectedPaymentMethod = 'MPESA';
                this.initializeEventListeners();
                this.setupCORSProxy();
            }

            setupCORSProxy() {
                // For development/testing only - use a CORS proxy
                this.corsProxy = 'https://api.allorigins.win/raw?url=';
                // Alternative: 'https://cors-anywhere.herokuapp.com/'
            }

            initializeEventListeners() {
                // Payment method selection
                document.querySelectorAll('.payment-method').forEach(method => {
                    method.addEventListener('click', (e) => {
                        document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                        this.selectedPaymentMethod = e.currentTarget.dataset.method;
                    });
                });

                // Form submission
                document.getElementById('paymentForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.processPayment();
                });

                // Real-time validation
                document.getElementById('customerEmail').addEventListener('blur', this.validateEmail);
                document.getElementById('customerPhone').addEventListener('blur', this.validatePhone);
                document.getElementById('amount').addEventListener('input', this.validateAmount);
                
                // Auto-format phone number
                document.getElementById('customerPhone').addEventListener('blur', (e) => {
                    if (e.target.value) {
                        e.target.value = this.formatKenyanPhone(e.target.value);
                    }
                });
            }

            validateEmail(e) {
                const email = e.target.value;
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (email && !emailRegex.test(email)) {
                    e.target.style.borderColor = '#dc3545';
                } else {
                    e.target.style.borderColor = '#28a745';
                }
            }

            validatePhone(e) {
                const phone = e.target.value;
                const phoneRegex = /^\+254[17]\d{8}$/;
                if (phone && !phoneRegex.test(phone)) {
                    e.target.style.borderColor = '#dc3545';
                } else {
                    e.target.style.borderColor = '#28a745';
                }
            }

            validateAmount(e) {
                const amount = parseFloat(e.target.value);
                if (amount > 0) {
                    e.target.style.borderColor = '#28a745';
                } else {
                    e.target.style.borderColor = '#dc3545';
                }
            }

            formatKenyanPhone(phone) {
                // Remove any spaces, dashes, or other characters
                phone = phone.replace(/\D/g, '');
                
                // Handle different formats
                if (phone.startsWith('0')) {
                    phone = '254' + phone.substring(1);
                } else if (phone.startsWith('7') || phone.startsWith('1')) {
                    phone = '254' + phone;
                }
                
                return '+' + phone;
            }

            showStatus(message, type) {
                const statusDiv = document.getElementById('statusMessage');
                statusDiv.className = `status-message status-${type}`;
                statusDiv.innerHTML = message;
                statusDiv.style.display = 'block';
                
                if (type !== 'info') {
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 8000);
                }
            }

            async processPayment() {
                const publishableKey = document.getElementById('publishableKey').value;
                const secretKey = document.getElementById('secretKey').value;
                const environment = document.getElementById('apiEnvironment').value;
                
                if (!publishableKey) {
                    this.showStatus('‚ùå Please enter your IntaSend publishable key', 'error');
                    return;
                }

                if (!secretKey) {
                    this.showStatus('‚ùå Please enter your IntaSend secret key (required for M-PESA STK Push)', 'error');
                    return;
                }

                // Get form data
                const paymentData = {
                    email: document.getElementById('customerEmail').value,
                    phone: document.getElementById('customerPhone').value,
                    name: document.getElementById('customerName').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    currency: document.getElementById('currency').value,
                    description: document.getElementById('description').value || 'Payment',
                    method: this.selectedPaymentMethod
                };

                // Validate required fields
                if (!paymentData.email || !paymentData.phone || !paymentData.name || !paymentData.amount) {
                    this.showStatus('‚ùå Please fill in all required fields', 'error');
                    return;
                }

                if (paymentData.amount <= 0) {
                    this.showStatus('‚ùå Amount must be greater than 0', 'error');
                    return;
                }

                // Validate phone number format
                const phoneRegex = /^\+254[17]\d{8}$/;
                if (!phoneRegex.test(paymentData.phone)) {
                    this.showStatus('‚ùå Invalid phone number. Use format: +254700000000 or +254100000000', 'error');
                    return;
                }

                // Show loading state
                const payButton = document.getElementById('payButton');
                payButton.disabled = true;
                payButton.innerHTML = '<span class="loading"></span>Processing...';

                try {
                    if (paymentData.method === 'MPESA') {
                        await this.initiateMpesaPayment(publishableKey, secretKey, environment, paymentData);
                    } else {
                        await this.createWebCheckout(publishableKey, environment, paymentData);
                    }
                } catch (error) {
                    this.showStatus('‚ùå ' + error.message, 'error');
                    console.error('Payment error:', error);
                } finally {
                    // Reset button state
                    payButton.disabled = false;
                    payButton.innerHTML = 'Initiate Payment';
                }
            }

            async initiateMpesaPayment(publishableKey, secretKey, environment, paymentData) {
                const baseUrl = environment === 'test' 
                    ? 'https://sandbox.intasend.com' 
                    : 'https://payment.intasend.com';

                const mpesaData = {
                    amount: paymentData.amount,
                    phone_number: paymentData.phone,
                    api_ref: 'mpesa_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    narrative: paymentData.description
                };

                this.showStatus('üì± Sending M-PESA STK Push to ' + paymentData.phone + '...', 'info');

                try {
                    // Method 1: Try direct API call with proper headers
                    let response;
                    try {
                        response = await fetch(`${baseUrl}/api/v1/payment/mpesa-stk-push/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-IntaSend-Public-Key-Id': publishableKey,
                                'X-IntaSend-Secret-Key-Id': secretKey,
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(mpesaData)
                        });
                    } catch (corsError) {
                        // Method 2: If CORS fails, try with proxy (development only)
                        this.showStatus('üîÑ Trying alternative method...', 'info');
                        
                        const proxyUrl = this.corsProxy + encodeURIComponent(`${baseUrl}/api/v1/payment/mpesa-stk-push/`);
                        response = await fetch(proxyUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-IntaSend-Public-Key-Id': publishableKey,
                                'X-IntaSend-Secret-Key-Id': secretKey
                            },
                            body: JSON.stringify(mpesaData)
                        });
                    }

                    const responseText = await response.text();
                    let result;
                    
                    try {
                        result = JSON.parse(responseText);
                    } catch (parseError) {
                        throw new Error('Invalid response from server: ' + responseText.substring(0, 100));
                    }

                    if (response.ok && result.invoice) {
                        this.showStatus('‚úÖ M-PESA prompt sent successfully! Check your phone to complete payment.', 'success');
                        
                        // Show payment details
                        setTimeout(() => {
                            this.showStatus(`üí∞ Payment Details:<br>
                                Amount: ${paymentData.currency} ${paymentData.amount}<br>
                                Phone: ${paymentData.phone}<br>
                                Reference: ${mpesaData.api_ref}<br>
                                <em>Complete payment on your phone within 2 minutes</em>`, 'info');
                        }, 2000);
                        
                        // Poll for payment status
                        this.pollPaymentStatus(publishableKey, secretKey, baseUrl, result.invoice.invoice_id);
                        
                    } else if (result.detail) {
                        throw new Error(result.detail);
                    } else if (result.message) {
                        throw new Error(result.message);
                    } else {
                        throw new Error('M-PESA request failed: ' + JSON.stringify(result));
                    }

                } catch (error) {
                    console.error('M-PESA Error Details:', error);
                    
                    if (error.message.includes('CORS') || error.message.includes('fetch')) {
                        throw new Error('Network error. Please check your internet connection or try using a backend server.');
                    } else if (error.message.includes('401')) {
                        throw new Error('Invalid API keys. Please check your publishable and secret keys.');
                    } else if (error.message.includes('403')) {
                        throw new Error('Account verification required or insufficient permissions.');
                    } else if (error.message.includes('phone')) {
                        throw new Error('Invalid phone number or phone not registered with M-PESA.');
                    } else {
                        throw error;
                    }
                }
            }

            async createWebCheckout(publishableKey, environment, paymentData) {
                const baseUrl = environment === 'test' 
                    ? 'https://sandbox.intasend.com' 
                    : 'https://payment.intasend.com';

                const checkoutData = {
                    public_key: publishableKey,
                    amount: paymentData.amount,
                    currency: paymentData.currency,
                    email: paymentData.email,
                    phone_number: paymentData.phone,
                    name: paymentData.name,
                    api_ref: 'checkout_' + Date.now(),
                    redirect_url: window.location.origin + '?status=success',
                    cancel_url: window.location.origin + '?status=cancelled'
                };

                this.showStatus('üåê Creating web checkout session...', 'info');

                try {
                    let response;
                    try {
                        response = await fetch(`${baseUrl}/api/v1/checkout/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-IntaSend-Public-Key-Id': publishableKey
                            },
                            body: JSON.stringify(checkoutData)
                        });
                    } catch (corsError) {
                        const proxyUrl = this.corsProxy + encodeURIComponent(`${baseUrl}/api/v1/checkout/`);
                        response = await fetch(proxyUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-IntaSend-Public-Key-Id': publishableKey
                            },
                            body: JSON.stringify(checkoutData)
                        });
                    }

                    const result = await response.json();
                    
                    if (response.ok && result.url) {
                        this.showStatus('‚úÖ Redirecting to IntaSend checkout page...', 'success');
                        setTimeout(() => {
                            window.open(result.url, '_blank');
                        }, 1500);
                    } else {
                        throw new Error(result.detail || result.message || 'Failed to create checkout session');
                    }

                } catch (error) {
                    throw new Error('Checkout creation failed: ' + error.message);
                }
            }

            async pollPaymentStatus(publishableKey, secretKey, baseUrl, invoiceId) {
                let attempts = 0;
                const maxAttempts = 12; // Poll for 2 minutes max (10 seconds each)

                const poll = async () => {
                    try {
                        let response;
                        try {
                            response = await fetch(`${baseUrl}/api/v1/payment/status/${invoiceId}/`, {
                                headers: {
                                    'X-IntaSend-Public-Key-Id': publishableKey,
                                    'X-IntaSend-Secret-Key-Id': secretKey
                                }
                            });
                        } catch (corsError) {
                            const proxyUrl = this.corsProxy + encodeURIComponent(`${baseUrl}/api/v1/payment/status/${invoiceId}/`);
                            response = await fetch(proxyUrl, {
                                headers: {
                                    'X-IntaSend-Public-Key-Id': publishableKey,
                                    'X-IntaSend-Secret-Key-Id': secretKey
                                }
                            });
                        }

                        const result = await response.json();

                        if (result.invoice) {
                            if (result.invoice.state === 'COMPLETE') {
                                this.showStatus('üéâ Payment completed successfully!<br>Amount: ' + result.invoice.currency + ' ' + result.invoice.value, 'success');
                                
                                // Reset form after successful payment
                                setTimeout(() => {
                                    document.getElementById('paymentForm').reset();
                                    document.getElementById('publishableKey').value = 'ISPubKey_test_0c2a0c0d-b406-43e6-9a53-50967c70d608';
                                    document.getElementById('amount').value = '10';
                                    document.getElementById('description').value = 'Test payment';
                                }, 5000);
                                return;
                            } else if (result.invoice.state === 'FAILED') {
                                this.showStatus('‚ùå Payment failed or was cancelled. Please try again.', 'error');
                                return;
                            } else if (result.invoice.state === 'PENDING') {
                                this.showStatus('‚è≥ Payment is pending. Please complete the payment on your phone.', 'warning');
                            }
                        }

                        attempts++;
                        if (attempts < maxAttempts) {
                            setTimeout(poll, 10000); // Poll every 10 seconds
                        } else {
                            this.showStatus('‚è∞ Payment status check timed out. Please check your M-PESA messages manually.', 'warning');
                        }

                    } catch (error) {
                        console.error('Status polling error:', error);
                        this.showStatus('üì± Unable to check payment status automatically. Please verify payment in your M-PESA messages.', 'info');
                    }
                };

                // Start polling after 5 seconds
                setTimeout(poll, 5000);
            }
        }

        // Initialize the payment application
        document.addEventListener('DOMContentLoaded', () => {
            new IntaSendPayment();
        });

        // Check URL parameters for payment status
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const status = urlParams.get('status');
            
            if (status === 'success') {
                document.querySelector('.status-message').innerHTML = 'üéâ Payment completed successfully!';
                document.querySelector('.status-message').className = 'status-message status-success';
                document.querySelector('.status-message').style.display = 'block';
            } else if (status === 'cancelled') {
                document.querySelector('.status-message').innerHTML = '‚ùå Payment was cancelled.';
                document.querySelector('.status-message').className = 'status-message status-error';
                document.querySelector('.status-message').style.display = 'block';
            }
        });
    </script>
</body>
</html>